<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stribe Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
        .login-wrapper { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-container { background: white; border-radius: 20px; padding: 40px 30px; width: 100%; max-width: 350px; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo span { font-size: 50px; }
        .logo h1 { font-size: 24px; color: #333; margin-top: 10px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; }
        .login-btn { width: 100%; padding: 16px; background: #667eea; border: none; border-radius: 12px; color: white; font-size: 18px; }
        .error-msg { color: red; text-align: center; margin-top: 15px; display: none; }
        .main-wrapper { padding: 20px; padding-top: 60px; }
        .player-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .player-name { font-size: 22px; font-weight: bold; }
        .player-info { color: #666; margin-top: 5px; }
        .player-detail { color: #888; font-size: 14px; margin-top: 8px; line-height: 1.6; }
        /* ì˜¤ëŠ˜ ê³¼ì œ ì„¹ì…˜ */
        .today-task-section { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; }
        .task-header { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .task-header-icon { font-size: 20px; }
        .task-header-title { font-size: 18px; font-weight: bold; color: #333; flex: 1; }
        .task-date { font-size: 13px; color: #888; }
        .task-category { margin-bottom: 15px; }
        .category-title { font-size: 14px; font-weight: 600; color: #667eea; margin-bottom: 8px; }
        .category-content { background: #f8f9fa; border-radius: 10px; padding: 12px; }
        .task-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .task-row:not(:last-child) { border-bottom: 1px solid #eee; }
        .task-row.single { justify-content: flex-start; }
        .task-row .task-label { font-size: 14px; color: #555; }
        .task-row .task-value { font-size: 14px; font-weight: 500; color: #333; }
        .video-link { display: block; margin-top: 8px; color: #667eea; font-size: 13px; text-decoration: none; }
        .video-btn { display: block; margin-top: 10px; padding: 12px; background: #667eea; color: white; text-align: center; border-radius: 10px; text-decoration: none; font-size: 14px; font-weight: 600; }
        .task-status { text-align: center; font-size: 11px; color: #888; margin-top: 10px; }
        .menu-btn { display: block; width: 100%; padding: 20px; background: white; border: none; border-radius: 15px; margin-bottom: 10px; font-size: 16px; text-align: left; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 20px; margin-bottom: 20px; }
        .top-buttons { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .refresh-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 20px; display: flex; align-items: center; gap: 6px; }
        .refresh-btn.loading { opacity: 0.6; }
        .sub-header { background: white; padding: 15px 20px; padding-top: 50px; display: flex; align-items: center; gap: 15px; }
        .back-btn { background: none; border: none; font-size: 24px; }
        .sub-title { font-size: 18px; font-weight: bold; }
        .sub-content { padding: 20px; padding-bottom: 100px; }
        .section-title { color: white; font-size: 14px; margin-bottom: 10px; margin-top: 15px; }
        .section-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .task-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .task-item:last-child { border-bottom: none; }
        .task-label { color: #555; }
        .task-value { font-weight: 600; color: #667eea; }
        .today-date { color: white; text-align: center; font-size: 16px; margin-bottom: 15px; }
        .card-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px; }
        .form-section { margin-bottom: 20px; }
        .form-label { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; display: block; }
        .time-row { display: flex; gap: 10px; }
        .time-group { flex: 1; }
        .time-group label { font-size: 12px; color: #666; margin-bottom: 4px; display: block; }
        .time-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f8f8f8; }
        .number-input { display: flex; align-items: center; background: #f8f8f8; border-radius: 8px; overflow: hidden; }
        .number-input input { flex: 1; border: none; background: transparent; padding: 12px; font-size: 16px; text-align: left; }
        .number-input button { width: 44px; height: 44px; border: none; background: transparent; font-size: 20px; color: #667eea; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input { width: 20px; height: 20px; accent-color: #667eea; }
        .checkbox-item label { font-size: 14px; color: #333; }
        .slider-container { margin-top: 10px; }
        .slider { width: 100%; height: 6px; border-radius: 3px; -webkit-appearance: none; background: #e0e0e0; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #667eea; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: #888; }
        .slider-value-box { background: #e8f0fe; border-radius: 8px; padding: 10px; margin-top: 10px; text-align: center; color: #667eea; font-weight: 500; }
        .concept-select { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f8f8f8; }
        .textarea { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 100px; resize: vertical; }
        .submit-btn { width: 100%; padding: 16px; background: #667eea; border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; margin-top: 20px; }
        .submit-btn:disabled { background: #aaa; }
        .status-msg { text-align: center; color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 10px; }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 320px; text-align: center; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .modal-msg { font-size: 14px; color: #666; margin-bottom: 25px; line-height: 1.5; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; }
        .modal-btn.cancel { background: #e0e0e0; color: #666; }
        .modal-btn.confirm { background: #667eea; color: white; }
        /* ë“±ë¡ í¼ ìŠ¤íƒ€ì¼ */
        .register-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="screen active" id="loginScreen">
        <div class="login-wrapper">
            <div class="login-container">
                <div class="logo">
                    <span>âš½</span>
                    <h1>Stribe Player</h1>
                </div>
                <div class="input-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">
                </div>
                <div class="input-group">
                    <label>ìƒë…„ì›”ì¼</label>
                    <input type="text" id="birthInput" placeholder="ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.">
                </div>
                <button class="login-btn" id="loginBtn">ë¡œê·¸ì¸</button>
                <p class="error-msg" id="errorMsg"></p>
            </div>
        </div>
    </div>
    <div class="screen" id="mainScreen">
        <div class="main-wrapper">
            <div class="top-buttons">
                <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
                <button class="refresh-btn" id="refreshBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="player-card">
                <div class="player-name" id="pName"></div>
                <div class="player-info" id="pInfo"></div>
                <div class="player-detail" id="pDetail"></div>
            </div>
            
            <!-- ì˜¤ëŠ˜ ê³¼ì œ ì„¹ì…˜ -->
            <div class="today-task-section">
                <div class="task-header">
                    <span class="task-header-icon">ğŸ“‹</span>
                    <span class="task-header-title">ì˜¤ëŠ˜ ê³¼ì œ</span>
                    <span class="task-date" id="mainTodayDate"></span>
                </div>
                
                <div class="task-category">
                    <div class="category-title">ğŸ¥— ì˜ì–‘ ì„­ì·¨</div>
                    <div class="category-content" id="mainNutrition">
                        <div class="task-row"><span class="task-label">ìˆ˜ë¶„ ì„­ì·¨</span><span class="task-value" id="mainWater">-</span></div>
                        <div class="task-row"><span class="task-label">ë‹¨ë°±ì§ˆ ì„­ì·¨</span><span class="task-value" id="mainProtein">-</span></div>
                        <div class="task-row"><span class="task-label">ì¶”ê°€ ì„­ì·¨</span><span class="task-value" id="mainFood">-</span></div>
                    </div>
                </div>
                
                <div class="task-category">
                    <div class="category-title">ğŸ©¹ íšŒë³µ ì „ëµ</div>
                    <div class="category-content">
                        <div class="task-row single"><span class="task-value" id="mainRecovery">-</span></div>
                    </div>
                </div>
                
                <div class="task-category">
                    <div class="category-title">ğŸ‹ï¸ ë³´ì¶© í›ˆë ¨</div>
                    <div class="category-content">
                        <div class="task-row single"><span class="task-value" id="mainExercise">-</span></div>
                    </div>
                    <a class="video-btn" id="mainVideoLink" href="#" target="_blank" style="display:none;">ğŸ“¹ ì˜ìƒ ë³´ê¸°</a>
                </div>
                
                <div class="task-status" id="mainTaskStatus"></div>
            </div>
            
            <!-- ë©”ë‰´ ë²„íŠ¼ë“¤ -->
            <button class="menu-btn" id="btnCondition">ğŸ’ª ë°ì¼ë¦¬ ì»¨ë””ì…˜ ì²´í¬</button>
            <button class="menu-btn" id="btnWorkout">ğŸƒ ì˜¤ëŠ˜ í›ˆë ¨</button>
            <button class="menu-btn" id="btnTest">ğŸ“Š í”¼ì§€ì»¬ í…ŒìŠ¤íŠ¸</button>
        </div>
    </div>
    <div class="screen" id="conditionScreen">
        <div class="sub-header">
            <button class="back-btn" id="conditionBack">â†</button>
            <div class="sub-title">ë°ì¼ë¦¬ ì»¨ë””ì…˜</div>
        </div>
        <div class="sub-content">
            <div class="today-date" id="conditionDate"></div>
            <div class="section-card">
                <div class="card-title">1. ì˜ì–‘ ğŸ</div>
                <div class="form-section">
                    <label class="form-label">1-1. ì‹ì‚¬ ê·œì¹™ì„±</label>
                    <div class="time-row">
                        <div class="time-group"><label>ì•„ì¹¨</label><input type="time" class="time-input" id="mealBreakfast" value="08:00" step="300"></div>
                        <div class="time-group"><label>ì ì‹¬</label><input type="time" class="time-input" id="mealLunch" value="12:00" step="300"></div>
                        <div class="time-group"><label>ì €ë…</label><input type="time" class="time-input" id="mealDinner" value="18:00" step="300"></div>
                    </div>
                </div>
                <div class="form-section">
                    <label class="form-label">1-2. ë‹¨ë°±ì§ˆ ì„­ì·¨ íšŸìˆ˜</label>
                    <div class="number-input">
                        <input type="number" id="proteinCount" value="3" min="0" max="10">
                        <button id="proteinMinus">âˆ’</button>
                        <button id="proteinPlus">+</button>
                    </div>
                </div>
                <div class="form-section">
                    <label class="form-label">1-3. ìˆ˜ë¶„ ì„­ì·¨ (ë¦¬í„°)</label>
                    <div class="number-input">
                        <input type="number" id="waterIntake" value="2.00" min="0" max="10" step="0.25">
                        <button id="waterMinus">âˆ’</button>
                        <button id="waterPlus">+</button>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="card-title">2. íšŒë³µ ğŸ”„</div>
                <div class="form-section">
                    <label class="form-label">2-1. ë¶€ìƒ ë° í†µì¦ ë¶€ìœ„</label>
                    <input type="text" class="register-input" id="injuryArea" placeholder="ì˜ˆ: ì˜¤ë¥¸ìª½ í–„ìŠ¤íŠ¸ë§, ì™¼ìª½ ë°œëª© ë“±" style="margin-bottom: 0;">
                </div>
                <div class="form-section">
                    <label class="form-label">2-2. íšŒë³µ ë°©ë²•</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item"><input type="checkbox" id="recFoamroller"><label>í¼ë¡¤ëŸ¬</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recManual"><label>ë§¤ë‰´ì–¼</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recCold"><label>ëƒ‰ìš•/ëƒ‰ì°œì§ˆ</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recCompression"><label>ì••ë°•ì˜ë¥˜</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recPhysio"><label>ë¬¼ë¦¬ì¹˜ë£Œ</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recOriental"><label>í•œë°©ì¹˜ë£Œ</label></div>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="card-title">3. í›ˆë ¨ ğŸ’ª</div>
                <div class="form-section">
                    <label class="form-label">3-1. ìê°ë„ (RPE)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="rpeSlider" min="1" max="10" value="5">
                        <div class="slider-labels"><span>1</span><span>5</span><span>10</span></div>
                    </div>
                    <div class="slider-value-box" id="rpeDisplay">ğŸ˜ ìê°ë„: 5/10 - ë³´í†µ ê°•ë„</div>
                </div>
                <div class="form-section">
                    <label class="form-label">3-2. í›ˆë ¨ ì‹œê°„ (ë¶„)</label>
                    <div class="number-input">
                        <input type="number" id="trainingTime" value="90" min="0" max="300" step="5">
                        <button id="timeMinus">âˆ’</button>
                        <button id="timePlus">+</button>
                    </div>
                </div>
                <div class="form-section">
                    <label class="form-label">3-3. í›ˆë ¨ ì»¨ì…‰</label>
                    <select class="concept-select" id="trainingConcept">
                        <option value="í•„ë“œ">í•„ë“œ</option>
                        <option value="ì§">ì§</option>
                        <option value="í•„ë“œ+ì§">í•„ë“œ+ì§</option>
                        <option value="íœ´ì‹">íœ´ì‹</option>
                        <option value="ì¬í™œ">ì¬í™œ</option>
                    </select>
                </div>
            </div>
            <div class="section-card">
                <div class="card-title">ğŸ“ ë¶€ìƒ ë° í†µì¦ ë¶€ìœ„</div>
                <textarea class="textarea" id="painNote" placeholder="í†µì¦ ë¶€ìœ„, ì»¨ë””ì…˜, íŠ¹ì´ì‚¬í•­ ë“±ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>
            <button class="submit-btn" id="submitCondition">ì €ì¥í•˜ê¸°</button>
            <div class="status-msg" id="saveStatus"></div>
        </div>
    </div>
    <!-- ì‹ ê·œ ë“±ë¡ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-box">
            <div class="modal-title">ë“±ë¡ë˜ì§€ ì•Šì€ ì„ ìˆ˜</div>
            <div class="modal-msg">ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ìƒˆë¡œ ì…ë ¥ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="modal-btns">
                <button class="modal-btn cancel" id="modalCancel">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" id="modalConfirm">ì…ë ¥</button>
            </div>
        </div>
    </div>
    <!-- ì‹ ê·œ ì„ ìˆ˜ ë“±ë¡ í™”ë©´ -->
    <div class="screen" id="registerScreen">
        <div class="sub-header">
            <button class="back-btn" id="registerBack">â†</button>
            <div class="sub-title">ì‹ ê·œ ì„ ìˆ˜ ë“±ë¡</div>
        </div>
        <div class="sub-content">
            <div class="section-card">
                <div class="card-title">ì„ ìˆ˜ ì •ë³´ ì…ë ¥</div>
                <input type="text" class="register-input" id="regName" placeholder="ì´ë¦„" readonly>
                <input type="text" class="register-input" id="regBirth" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 96.09.20)">
                <select class="register-input" id="regSport">
                    <option value="">ì¢…ëª© ì„ íƒ</option>
                    <option value="ì¶•êµ¬">ì¶•êµ¬</option>
                    <option value="ì•¼êµ¬">ì•¼êµ¬</option>
                    <option value="ë†êµ¬">ë†êµ¬</option>
                    <option value="ë°°êµ¬">ë°°êµ¬</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <input type="text" class="register-input" id="regTeam" placeholder="ì†Œì†íŒ€">
                <input type="text" class="register-input" id="regPosition" placeholder="í¬ì§€ì…˜">
            </div>
            <button class="submit-btn" id="submitRegister">ë“±ë¡í•˜ê¸°</button>
            <div class="status-msg" id="registerStatus"></div>
        </div>
    </div>
<script>
var API_URL = "https://script.google.com/macros/s/AKfycbwhd09t-7hMy5APQPl9FYg7P6Z8vI-AbREC2wGvqK3kDDw08A4ow31ECa_MLh1o_2hS/exec";
var players = [];
var currentPlayer = null;

// í˜ì´ì§€ ë¡œë“œì‹œ ì„ ìˆ˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
fetch(API_URL)
    .then(function(r) { return r.json(); })
    .then(function(data) {
        players = data.map(function(p) {
            return {
                name: p.name,
                birth: formatBirthdate(p.birthdate),
                team: p.team,
                pos: p.position,
                sport: p.sport
            };
        });
    })
    .catch(function() {
        // ì˜¤í”„ë¼ì¸ í´ë°±
        players = [
            {name: "ì†¡ê¸°í˜¸", birth: "1989-3-2", team: "FCì„œìš¸", pos: "FB", sport: "ì¶•êµ¬"},
            {name: "ê¹€ì„±í™˜", birth: "1996-9-20", team: "ëŒ€ì „í•˜ë‚˜ì‹œí‹°ì¦Œ", pos: "MF", sport: "ì¶•êµ¬"}
        ];
    });

function formatBirthdate(date) {
    if (!date) return "";
    var str = String(date).trim();
    
    // ì´ë¯¸ 6ìë¦¬ ìˆ«ìë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    if (/^\d{6}$/.test(str)) {
        return str;
    }
    
    // ì•ìë¦¬ 0ì´ ì˜ë¦° ê²½ìš° (ì˜ˆ: 101 â†’ 000101)
    if (/^\d+$/.test(str) && str.length < 6) {
        return str.padStart(6, "0");
    }
    
    // 96.09.20 í˜•ì‹ â†’ 960920
    if (str.includes(".")) {
        var parts = str.split(".");
        var y = parts[0].padStart(2, "0");
        var m = parts[1].padStart(2, "0");
        var d = parts[2].padStart(2, "0");
        return y + m + d;
    }
    
    // 1996-09-20 ë˜ëŠ” 1996-9-20 í˜•ì‹ â†’ 960920
    if (str.includes("-")) {
        var parts = str.split("-");
        var y = parts[0].slice(-2);
        var m = parts[1].padStart(2, "0");
        var d = parts[2].padStart(2, "0");
        return y + m + d;
    }
    
    return str;
}

// ì…ë ¥ê°’ì„ 6ìë¦¬ë¡œ ë³€í™˜
function normalizeInput(birth) {
    var s = birth.replace(/[\.\-\/]/g, "");
    if (s.length === 6) {
        return s;
    }
    if (s.length === 8) {
        // 19960920 â†’ 960920
        return s.slice(2);
    }
    // ì•ìë¦¬ 0ì´ ì˜ë¦° ê²½ìš° (ì˜ˆ: 101 â†’ 000101)
    if (s.length < 6) {
        return s.padStart(6, "0");
    }
    return s;
}

function updateRpe() {
    var val = document.getElementById("rpeSlider").value;
    var emoji, text;
    if (val <= 2) { emoji = "ğŸ˜´"; text = "ë§¤ìš° ë‚®ì€ ê°•ë„"; }
    else if (val <= 4) { emoji = "ğŸ™‚"; text = "ë‚®ì€ ê°•ë„"; }
    else if (val <= 6) { emoji = "ğŸ˜"; text = "ë³´í†µ ê°•ë„"; }
    else if (val <= 8) { emoji = "ğŸ˜¤"; text = "ë†’ì€ ê°•ë„"; }
    else { emoji = "ğŸ¥µ"; text = "ë§¤ìš° ë†’ì€ ê°•ë„"; }
    document.getElementById("rpeDisplay").textContent = emoji + " ìê°ë„: " + val + "/10 - " + text;
}

// ì˜¤ëŠ˜ ê³¼ì œ ë¶ˆëŸ¬ì˜¤ê¸°
function loadTodayTasks() {
    var today = new Date();
    var todayStr = today.getFullYear() + "-" + (today.getMonth()+1) + "-" + today.getDate();
    document.getElementById("mainTodayDate").textContent = (today.getMonth()+1) + "ì›” " + today.getDate() + "ì¼";
    document.getElementById("mainTaskStatus").textContent = "ë¡œë”©ì¤‘...";
    
    fetch(API_URL + "?action=tasks")
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var myTask = null;
            for (var i = 0; i < data.length; i++) {
                // API ë‚ ì§œë¥¼ íŒŒì‹±í•´ì„œ ë¹„êµ
                var apiDate = new Date(data[i].date);
                var apiDateStr = apiDate.getFullYear() + "-" + (apiDate.getMonth()+1) + "-" + apiDate.getDate();
                
                if (data[i].name === currentPlayer.name && apiDateStr === todayStr) {
                    myTask = data[i];
                    break;
                }
            }
            if (myTask) {
                document.getElementById("mainWater").textContent = myTask.water ? myTask.water + "L" : "-";
                document.getElementById("mainProtein").textContent = myTask.protein ? myTask.protein + "íšŒ" : "-";
                document.getElementById("mainFood").textContent = myTask.food || "-";
                document.getElementById("mainRecovery").textContent = myTask.recovery || "-";
                document.getElementById("mainExercise").textContent = myTask.exercise || "-";
                if (myTask.videoLink) {
                    document.getElementById("mainVideoLink").href = myTask.videoLink;
                    document.getElementById("mainVideoLink").style.display = "block";
                } else {
                    document.getElementById("mainVideoLink").style.display = "none";
                }
                document.getElementById("mainTaskStatus").textContent = "âœ“ ì‹¤ì‹œê°„ ë°ì´í„°";
            } else {
                setDefaultTasks();
            }
        })
        .catch(function() {
            setDefaultTasks();
        });
}

function setDefaultTasks() {
    document.getElementById("mainWater").textContent = "-";
    document.getElementById("mainProtein").textContent = "-";
    document.getElementById("mainFood").textContent = "-";
    document.getElementById("mainRecovery").textContent = "-";
    document.getElementById("mainExercise").textContent = "-";
    document.getElementById("mainVideoLink").style.display = "none";
    document.getElementById("mainTaskStatus").textContent = "ì˜¤ëŠ˜ ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤";
}

document.getElementById("loginBtn").onclick = function() {
    var name = document.getElementById("nameInput").value.trim();
    var birth = document.getElementById("birthInput").value.trim();
    var inputBirth = normalizeInput(birth);
    
    var found = null;
    for (var i = 0; i < players.length; i++) {
        if (players[i].name === name && players[i].birth === inputBirth) {
            found = players[i];
            break;
        }
    }
    if (found) {
        currentPlayer = found;
        document.getElementById("pName").textContent = found.name;
        
        // ìƒë…„ì›”ì¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ë° ë§Œë‚˜ì´ ê³„ì‚°
        var birthStr = found.birth; // 6ìë¦¬ (ì˜ˆ: 960920)
        var year = parseInt(birthStr.substr(0, 2));
        var month = parseInt(birthStr.substr(2, 2));
        var day = parseInt(birthStr.substr(4, 2));
        year = year > 50 ? 1900 + year : 2000 + year;
        var formattedBirth = year + "-" + String(month).padStart(2, "0") + "-" + String(day).padStart(2, "0");
        
        // ë§Œë‚˜ì´ ê³„ì‚°
        var today = new Date();
        var age = today.getFullYear() - year;
        var birthDate = new Date(year, month - 1, day);
        if (today < new Date(today.getFullYear(), month - 1, day)) {
            age--;
        }
        
        document.getElementById("pInfo").textContent = formattedBirth + " (ë§Œ " + age + "ì„¸)";
        document.getElementById("pDetail").textContent = found.team + " | " + found.pos + " | " + found.sport;
        document.getElementById("loginScreen").classList.remove("active");
        document.getElementById("mainScreen").classList.add("active");
        // ì˜¤ëŠ˜ ê³¼ì œ ë¶ˆëŸ¬ì˜¤ê¸°
        loadTodayTasks();
    } else {
        // ë“±ë¡ë˜ì§€ ì•Šì€ ì„ ìˆ˜ - ëª¨ë‹¬ í‘œì‹œ
        document.getElementById("registerModal").classList.add("active");
    }
};

document.getElementById("logoutBtn").onclick = function() {
    document.getElementById("mainScreen").classList.remove("active");
    document.getElementById("loginScreen").classList.add("active");
};

document.getElementById("refreshBtn").onclick = function() {
    var btn = this;
    btn.classList.add("loading");
    btn.textContent = "ë¡œë”©...";
    
    // ì„ ìˆ˜ ëª©ë¡ê³¼ ì˜¤ëŠ˜ ê³¼ì œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(API_URL)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            players = data.map(function(p) {
                return {
                    name: p.name,
                    birth: normalizeBirth(p.birthdate),
                    team: p.team,
                    pos: p.position,
                    sport: p.sport
                };
            });
            // ì˜¤ëŠ˜ ê³¼ì œë„ ìƒˆë¡œê³ ì¹¨
            loadTodayTasks();
            
            btn.classList.remove("loading");
            btn.textContent = "ğŸ”„ ìƒˆë¡œê³ ì¹¨";
        })
        .catch(function() {
            btn.classList.remove("loading");
            btn.textContent = "ğŸ”„ ìƒˆë¡œê³ ì¹¨";
        });
};

document.getElementById("btnCondition").onclick = function() {
    document.getElementById("mainScreen").classList.remove("active");
    document.getElementById("conditionScreen").classList.add("active");
    var today = new Date();
    document.getElementById("conditionDate").textContent = today.getFullYear() + "ë…„ " + (today.getMonth()+1) + "ì›” " + today.getDate() + "ì¼";
    updateRpe();
};

document.getElementById("conditionBack").onclick = function() {
    document.getElementById("conditionScreen").classList.remove("active");
    document.getElementById("mainScreen").classList.add("active");
};

document.getElementById("rpeSlider").oninput = updateRpe;

document.getElementById("proteinMinus").onclick = function() {
    var input = document.getElementById("proteinCount");
    if (parseInt(input.value) > 0) input.value = parseInt(input.value) - 1;
};
document.getElementById("proteinPlus").onclick = function() {
    var input = document.getElementById("proteinCount");
    if (parseInt(input.value) < 10) input.value = parseInt(input.value) + 1;
};
document.getElementById("waterMinus").onclick = function() {
    var input = document.getElementById("waterIntake");
    if (parseFloat(input.value) > 0) input.value = (parseFloat(input.value) - 0.25).toFixed(2);
};
document.getElementById("waterPlus").onclick = function() {
    var input = document.getElementById("waterIntake");
    if (parseFloat(input.value) < 10) input.value = (parseFloat(input.value) + 0.25).toFixed(2);
};
document.getElementById("timeMinus").onclick = function() {
    var input = document.getElementById("trainingTime");
    if (parseInt(input.value) > 0) input.value = parseInt(input.value) - 5;
};
document.getElementById("timePlus").onclick = function() {
    var input = document.getElementById("trainingTime");
    if (parseInt(input.value) < 300) input.value = parseInt(input.value) + 5;
};

document.getElementById("submitCondition").onclick = function() {
    var btn = document.getElementById("submitCondition");
    btn.disabled = true;
    btn.textContent = "ì €ì¥ì¤‘...";
    document.getElementById("saveStatus").textContent = "";
    
    var recovery = [];
    if (document.getElementById("recFoamroller").checked) recovery.push("í¼ë¡¤ëŸ¬");
    if (document.getElementById("recManual").checked) recovery.push("ë§¤ë‰´ì–¼");
    if (document.getElementById("recCold").checked) recovery.push("ëƒ‰ìš•/ëƒ‰ì°œì§ˆ");
    if (document.getElementById("recCompression").checked) recovery.push("ì••ë°•ì˜ë¥˜");
    if (document.getElementById("recPhysio").checked) recovery.push("ë¬¼ë¦¬ì¹˜ë£Œ");
    if (document.getElementById("recOriental").checked) recovery.push("í•œë°©ì¹˜ë£Œ");
    
    var today = new Date();
    var params = new URLSearchParams({
        action: "saveCondition",
        date: today.getFullYear() + "-" + (today.getMonth()+1) + "-" + today.getDate(),
        player: currentPlayer.name,
        breakfast: document.getElementById("mealBreakfast").value,
        lunch: document.getElementById("mealLunch").value,
        dinner: document.getElementById("mealDinner").value,
        protein: document.getElementById("proteinCount").value,
        water: document.getElementById("waterIntake").value,
        injury: document.getElementById("injuryArea").value || "ì—†ìŒ",
        recovery: recovery.join(", ") || "ì—†ìŒ",
        rpe: document.getElementById("rpeSlider").value,
        trainingTime: document.getElementById("trainingTime").value,
        trainingConcept: document.getElementById("trainingConcept").value,
        painNote: document.getElementById("painNote").value || "ì—†ìŒ"
    });
    
    fetch(API_URL + "?" + params.toString())
        .then(function(r) { return r.json(); })
        .then(function(result) {
            btn.disabled = false;
            btn.textContent = "ì €ì¥í•˜ê¸°";
            if (result.success) {
                document.getElementById("saveStatus").textContent = "âœ“ êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!";
                setTimeout(function() {
                    document.getElementById("conditionScreen").classList.remove("active");
                    document.getElementById("mainScreen").classList.add("active");
                }, 1500);
            }
        })
        .catch(function() {
            btn.disabled = false;
            btn.textContent = "ì €ì¥í•˜ê¸°";
            document.getElementById("saveStatus").textContent = "ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        });
};

document.getElementById("btnWorkout").onclick = function() { alert("ì¤€ë¹„ì¤‘"); };
document.getElementById("btnTest").onclick = function() { alert("ì¤€ë¹„ì¤‘"); };

// ëª¨ë‹¬ ì·¨ì†Œ ë²„íŠ¼
document.getElementById("modalCancel").onclick = function() {
    document.getElementById("registerModal").classList.remove("active");
};

// ëª¨ë‹¬ ì…ë ¥ ë²„íŠ¼ - ë“±ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™
document.getElementById("modalConfirm").onclick = function() {
    document.getElementById("registerModal").classList.remove("active");
    document.getElementById("loginScreen").classList.remove("active");
    document.getElementById("registerScreen").classList.add("active");
    // ì…ë ¥í•œ ì´ë¦„ ìë™ ì±„ìš°ê¸°
    document.getElementById("regName").value = document.getElementById("nameInput").value.trim();
    document.getElementById("regBirth").value = document.getElementById("birthInput").value.trim();
};

// ë“±ë¡ í™”ë©´ ë’¤ë¡œê°€ê¸°
document.getElementById("registerBack").onclick = function() {
    document.getElementById("registerScreen").classList.remove("active");
    document.getElementById("loginScreen").classList.add("active");
};

// ì„ ìˆ˜ ë“±ë¡ ì €ì¥
document.getElementById("submitRegister").onclick = function() {
    var name = document.getElementById("regName").value.trim();
    var birth = document.getElementById("regBirth").value.trim();
    var sport = document.getElementById("regSport").value;
    var team = document.getElementById("regTeam").value.trim();
    var position = document.getElementById("regPosition").value.trim();
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!name || !birth || !sport || !team || !position) {
        document.getElementById("registerStatus").textContent = "ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        document.getElementById("registerStatus").style.color = "#ff6b6b";
        return;
    }
    
    // ìƒë…„ì›”ì¼ 6ìë¦¬ë¡œ ë³€í™˜
    var birthNormalized = normalizeInput(birth);
    
    var btn = document.getElementById("submitRegister");
    btn.disabled = true;
    btn.textContent = "ë“±ë¡ì¤‘...";
    document.getElementById("registerStatus").textContent = "";
    
    var params = new URLSearchParams({
        action: "registerPlayer",
        name: name,
        birthdate: birthNormalized,
        team: team,
        position: position,
        sport: sport
    });
    
    fetch(API_URL + "?" + params.toString())
        .then(function(r) { return r.json(); })
        .then(function(result) {
            btn.disabled = false;
            btn.textContent = "ë“±ë¡í•˜ê¸°";
            if (result.success) {
                document.getElementById("registerStatus").style.color = "rgba(255,255,255,0.9)";
                document.getElementById("registerStatus").textContent = "âœ“ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
                // ì„ ìˆ˜ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° - ì™„ë£Œ í›„ í™”ë©´ ì´ë™
                fetch(API_URL)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        players = data.map(function(p) {
                            return {
                                name: p.name,
                                birth: formatBirthdate(p.birthdate),
                                team: p.team,
                                pos: p.position,
                                sport: p.sport
                            };
                        });
                        // ëª©ë¡ ê°±ì‹  ì™„ë£Œ í›„ í™”ë©´ ì´ë™
                        setTimeout(function() {
                            document.getElementById("registerScreen").classList.remove("active");
                            document.getElementById("loginScreen").classList.add("active");
                        }, 1000);
                    });
            } else {
                document.getElementById("registerStatus").style.color = "#ff6b6b";
                document.getElementById("registerStatus").textContent = "ë“±ë¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            }
        })
        .catch(function() {
            btn.disabled = false;
            btn.textContent = "ë“±ë¡í•˜ê¸°";
            document.getElementById("registerStatus").style.color = "#ff6b6b";
            document.getElementById("registerStatus").textContent = "ë“±ë¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        });
};
</script>
</body>
</html>
