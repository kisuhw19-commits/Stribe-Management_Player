<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Stribe Player</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
        .login-wrapper { min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .login-container { background: white; border-radius: 20px; padding: 40px 30px; width: 100%; max-width: 350px; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo span { font-size: 50px; }
        .logo h1 { font-size: 24px; color: #333; margin-top: 10px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; color: #555; font-size: 14px; margin-bottom: 8px; }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; }
        .login-btn { width: 100%; padding: 16px; background: #667eea; border: none; border-radius: 12px; color: white; font-size: 18px; }
        .error-msg { color: red; text-align: center; margin-top: 15px; display: none; }
        .main-wrapper { padding: 20px; padding-top: 60px; }
        .player-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .player-name { font-size: 22px; font-weight: bold; }
        .player-info { color: #666; margin-top: 5px; }
        .player-detail { color: #888; font-size: 14px; margin-top: 8px; }
        .today-task-section { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; }
        .task-header { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .task-header-title { font-size: 18px; font-weight: bold; color: #333; flex: 1; }
        .task-date { font-size: 13px; color: #888; }
        .task-category { margin-bottom: 15px; }
        .category-title { font-size: 14px; font-weight: 600; color: #667eea; margin-bottom: 8px; }
        .category-content { background: #f8f9fa; border-radius: 10px; padding: 12px; }
        .task-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; }
        .task-row:last-child { border-bottom: none; }
        .task-row.single { justify-content: flex-start; }
        .task-label { font-size: 14px; color: #555; }
        .task-value { font-size: 14px; font-weight: 500; color: #333; }
        .video-btn { display: block; margin-top: 10px; padding: 12px; background: #667eea; color: white; text-align: center; border-radius: 10px; text-decoration: none; font-size: 14px; }
        .task-status { text-align: center; font-size: 11px; color: #888; margin-top: 10px; }
        .menu-btn { display: block; width: 100%; padding: 20px; background: white; border: none; border-radius: 15px; margin-bottom: 10px; font-size: 16px; text-align: left; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 20px; }
        .top-buttons { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .refresh-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 20px; }
        .sub-header { background: white; padding: 15px 20px; padding-top: 50px; display: flex; align-items: center; gap: 15px; }
        .back-btn { background: none; border: none; font-size: 24px; }
        .sub-title { font-size: 18px; font-weight: bold; }
        .sub-content { padding: 20px; padding-bottom: 100px; }
        .section-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .today-date { color: white; text-align: center; font-size: 16px; margin-bottom: 15px; }
        .card-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px; }
        .form-section { margin-bottom: 20px; }
        .form-label { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; display: block; }
        .time-row { display: flex; gap: 10px; }
        .time-group { flex: 1; }
        .time-group label { font-size: 12px; color: #666; margin-bottom: 4px; display: block; }
        .time-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f8f8f8; }
        .number-input { display: flex; align-items: center; background: #f8f8f8; border-radius: 8px; }
        .number-input input { flex: 1; border: none; background: transparent; padding: 12px; font-size: 16px; }
        .number-input button { width: 44px; height: 44px; border: none; background: transparent; font-size: 20px; color: #667eea; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input { width: 20px; height: 20px; accent-color: #667eea; }
        .checkbox-item label { font-size: 14px; color: #333; }
        .slider { width: 100%; height: 6px; border-radius: 3px; -webkit-appearance: none; background: #e0e0e0; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #667eea; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: #888; }
        .slider-value-box { background: #e8f0fe; border-radius: 8px; padding: 10px; margin-top: 10px; text-align: center; color: #667eea; }
        .concept-select { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: #f8f8f8; }
        .textarea { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 80px; }
        .submit-btn { width: 100%; padding: 16px; background: #667eea; border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; margin-top: 20px; }
        .submit-btn:disabled { background: #aaa; }
        .status-msg { text-align: center; color: rgba(255,255,255,0.9); font-size: 14px; margin-top: 15px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 320px; text-align: center; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .modal-msg { font-size: 14px; color: #666; margin-bottom: 25px; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; }
        .modal-btn.cancel { background: #e0e0e0; color: #666; }
        .modal-btn.confirm { background: #667eea; color: white; }
        .register-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; margin-bottom: 15px; }
        .workout-card { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; }
        .workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .workout-concept { font-size: 16px; font-weight: bold; color: #667eea; }
        .workout-time { font-size: 13px; color: #888; }
        .workout-info { margin-bottom: 12px; font-size: 13px; color: #555; }
        .workout-purpose { background: #f0f4ff; border-radius: 8px; padding: 10px 12px; margin-bottom: 10px; }
        .workout-purpose-label { font-size: 12px; color: #667eea; font-weight: 600; margin-bottom: 4px; }
        .workout-purpose-text { font-size: 14px; color: #333; }
        .workout-content { background: #f8f9fa; border-radius: 8px; padding: 12px; }
        .workout-content-label { font-size: 12px; color: #888; font-weight: 600; margin-bottom: 6px; }
        .workout-content-text { font-size: 14px; color: #333; line-height: 1.6; white-space: pre-wrap; }
        .workout-image { width: 100%; border-radius: 8px; margin-top: 10px; }
        .no-workout { text-align: center; padding: 40px 20px; }
        .no-workout-icon { font-size: 48px; margin-bottom: 15px; }
        .no-workout-text { font-size: 16px; color: #888; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ -->
    <div class="screen active" id="loginScreen">
        <div class="login-wrapper">
            <div class="login-container">
                <div class="logo"><span>âš½</span><h1>Stribe Player</h1></div>
                <div class="input-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="input-group">
                    <label>ìƒë…„ì›”ì¼</label>
                    <input type="text" id="birthInput" placeholder="ì˜ˆ: 960920">
                </div>
                <button class="login-btn" id="loginBtn">ë¡œê·¸ì¸</button>
                <p class="error-msg" id="errorMsg"></p>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ -->
    <div class="screen" id="mainScreen">
        <div class="main-wrapper">
            <div class="top-buttons">
                <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
                <button class="refresh-btn" id="refreshBtn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="player-card">
                <div class="player-name" id="pName"></div>
                <div class="player-info" id="pInfo"></div>
                <div class="player-detail" id="pDetail"></div>
            </div>
            <div class="today-task-section">
                <div class="task-header">
                    <span>ğŸ“‹</span>
                    <span class="task-header-title">ì˜¤ëŠ˜ ê³¼ì œ</span>
                    <span class="task-date" id="mainTodayDate"></span>
                </div>
                <div class="task-category">
                    <div class="category-title">ğŸ¥— ì˜ì–‘ ì„­ì·¨</div>
                    <div class="category-content">
                        <div class="task-row"><span class="task-label">ìˆ˜ë¶„</span><span class="task-value" id="mainWater">-</span></div>
                        <div class="task-row"><span class="task-label">ë‹¨ë°±ì§ˆ</span><span class="task-value" id="mainProtein">-</span></div>
                        <div class="task-row"><span class="task-label">ì¶”ê°€ ì„­ì·¨</span><span class="task-value" id="mainFood">-</span></div>
                    </div>
                </div>
                <div class="task-category">
                    <div class="category-title">ğŸ©¹ íšŒë³µ ì „ëµ</div>
                    <div class="category-content">
                        <div class="task-row single"><span class="task-value" id="mainRecovery">-</span></div>
                    </div>
                </div>
                <div class="task-category">
                    <div class="category-title">ğŸ‹ï¸ ë³´ì¶© í›ˆë ¨</div>
                    <div class="category-content">
                        <div class="task-row single"><span class="task-value" id="mainExercise">-</span></div>
                    </div>
                    <a class="video-btn" id="mainVideoLink" href="#" target="_blank" style="display:none;">ğŸ“¹ ì˜ìƒ ë³´ê¸°</a>
                </div>
                <div class="task-status" id="mainTaskStatus"></div>
            </div>
            <button class="menu-btn" id="btnCondition">ğŸ’ª ë°ì¼ë¦¬ ì»¨ë””ì…˜ ì²´í¬</button>
            <button class="menu-btn" id="btnWorkout">ğŸƒ í›ˆë ¨ ì¼ì§€</button>
            <button class="menu-btn" id="btnTest">ğŸ“Š í”¼ì§€ì»¬ í…ŒìŠ¤íŠ¸</button>
        </div>
    </div>

    <!-- ë°ì¼ë¦¬ ì»¨ë””ì…˜ -->
    <div class="screen" id="conditionScreen">
        <div class="sub-header">
            <button class="back-btn" id="conditionBack">â†</button>
            <div class="sub-title">ë°ì¼ë¦¬ ì»¨ë””ì…˜</div>
        </div>
        <div class="sub-content">
            <div class="today-date" id="conditionDate"></div>
            <div class="section-card">
                <div class="card-title">1. ì˜ì–‘ ğŸ</div>
                <div class="form-section">
                    <label class="form-label">ì‹ì‚¬ ì‹œê°„</label>
                    <div class="time-row">
                        <div class="time-group"><label>ì•„ì¹¨</label><input type="time" class="time-input" id="mealBreakfast" value="08:00"></div>
                        <div class="time-group"><label>ì ì‹¬</label><input type="time" class="time-input" id="mealLunch" value="12:00"></div>
                        <div class="time-group"><label>ì €ë…</label><input type="time" class="time-input" id="mealDinner" value="18:00"></div>
                    </div>
                </div>
                <div class="form-section">
                    <label class="form-label">ë‹¨ë°±ì§ˆ ì„­ì·¨ íšŸìˆ˜</label>
                    <div class="number-input">
                        <input type="number" id="proteinCount" value="3" min="0" max="10">
                        <button id="proteinMinus">âˆ’</button>
                        <button id="proteinPlus">+</button>
                    </div>
                </div>
                <div class="form-section">
                    <label class="form-label">ìˆ˜ë¶„ ì„­ì·¨ (L)</label>
                    <div class="number-input">
                        <input type="number" id="waterIntake" value="2.0" min="0" max="10" step="0.25">
                        <button id="waterMinus">âˆ’</button>
                        <button id="waterPlus">+</button>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="card-title">2. íšŒë³µ ğŸ”„</div>
                <div class="form-section">
                    <label class="form-label">ë¶€ìƒ/í†µì¦ ë¶€ìœ„</label>
                    <input type="text" class="textarea" id="injuryArea" placeholder="ì˜ˆ: ì˜¤ë¥¸ìª½ í–„ìŠ¤íŠ¸ë§" style="min-height:auto;">
                </div>
                <div class="form-section">
                    <label class="form-label">íšŒë³µ ë°©ë²•</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item"><input type="checkbox" id="recFoamroller"><label>í¼ë¡¤ëŸ¬</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recStretching"><label>ìŠ¤íŠ¸ë ˆì¹­</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recMassage"><label>ë§ˆì‚¬ì§€</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recCold"><label>ëƒ‰ì°œì§ˆ</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recHot"><label>ì˜¨ì°œì§ˆ</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="recCompression"><label>ì••ë°•ì˜ë¥˜</label></div>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="card-title">3. í›ˆë ¨ ğŸ’ª</div>
                <div class="form-section">
                    <label class="form-label">í›ˆë ¨ ì»¨ì…‰</label>
                    <select class="concept-select" id="trainingConcept">
                        <option value="">ì„ íƒ</option>
                        <option value="í•„ë“œí›ˆë ¨">í•„ë“œí›ˆë ¨</option>
                        <option value="ì§í›ˆë ¨">ì§í›ˆë ¨</option>
                        <option value="í•„ë“œ+ì§">í•„ë“œ+ì§</option>
                        <option value="íšŒë³µí›ˆë ¨">íšŒë³µí›ˆë ¨</option>
                        <option value="ê²½ê¸°">ê²½ê¸°</option>
                        <option value="íœ´ì‹">íœ´ì‹</option>
                    </select>
                </div>
                <div class="form-section">
                    <label class="form-label">í›ˆë ¨ ì‹œê°„ (ë¶„)</label>
                    <div class="number-input">
                        <input type="number" id="trainingTime" value="90" min="0" step="10">
                        <button id="timeMinus">âˆ’</button>
                        <button id="timePlus">+</button>
                    </div>
                </div>
                <div class="form-section">
                    <label class="form-label">ìš´ë™ ìê°ë„ (RPE)</label>
                    <input type="range" class="slider" id="rpeSlider" min="1" max="10" value="5">
                    <div class="slider-labels"><span>1 (ë§¤ìš° ì‰¬ì›€)</span><span>10 (ìµœëŒ€ ê°•ë„)</span></div>
                    <div class="slider-value-box" id="rpeDisplay">ğŸ˜ ìê°ë„: 5/10</div>
                </div>
                <div class="form-section">
                    <label class="form-label">ë¹„ê³ </label>
                    <textarea class="textarea" id="painNote" placeholder="íŠ¹ì´ì‚¬í•­"></textarea>
                </div>
            </div>
            <button class="submit-btn" id="saveConditionBtn">ì €ì¥í•˜ê¸°</button>
            <div class="status-msg" id="saveStatus"></div>
        </div>
    </div>

    <!-- í›ˆë ¨ ì¼ì§€ -->
    <div class="screen" id="workoutScreen">
        <div class="sub-header">
            <button class="back-btn" id="workoutBack">â†</button>
            <div class="sub-title">í›ˆë ¨ ì¼ì§€</div>
        </div>
        <div class="sub-content">
            <div class="section-card" style="margin-bottom: 15px;">
                <div class="form-section" style="margin-bottom: 0;">
                    <label class="form-label">ğŸ“… ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" class="time-input" id="workoutDatePicker" style="width: 100%; padding: 12px; font-size: 16px;">
                </div>
            </div>
            <div class="today-date" id="workoutDate"></div>
            <div id="workoutList"></div>
        </div>
    </div>

    <!-- ë“±ë¡ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-box">
            <div class="modal-title">ë“±ë¡ë˜ì§€ ì•Šì€ ì„ ìˆ˜</div>
            <div class="modal-msg">ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ìƒˆë¡œ ì…ë ¥ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="modal-btns">
                <button class="modal-btn cancel" id="modalCancel">ì·¨ì†Œ</button>
                <button class="modal-btn confirm" id="modalConfirm">ì…ë ¥</button>
            </div>
        </div>
    </div>

    <!-- ì„ ìˆ˜ ë“±ë¡ -->
    <div class="screen" id="registerScreen">
        <div class="sub-header">
            <button class="back-btn" id="registerBack">â†</button>
            <div class="sub-title">ì‹ ê·œ ì„ ìˆ˜ ë“±ë¡</div>
        </div>
        <div class="sub-content">
            <div class="section-card">
                <div class="card-title">ì„ ìˆ˜ ì •ë³´</div>
                <input type="text" class="register-input" id="regName" placeholder="ì´ë¦„">
                <input type="text" class="register-input" id="regBirth" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 960920)">
                <select class="register-input" id="regSport">
                    <option value="">ì¢…ëª© ì„ íƒ</option>
                    <option value="ì¶•êµ¬">ì¶•êµ¬</option>
                    <option value="ì•¼êµ¬">ì•¼êµ¬</option>
                    <option value="ë†êµ¬">ë†êµ¬</option>
                </select>
                <input type="text" class="register-input" id="regTeam" placeholder="ì†Œì†íŒ€">
                <input type="text" class="register-input" id="regPosition" placeholder="í¬ì§€ì…˜">
            </div>
            <button class="submit-btn" id="submitRegister">ë“±ë¡í•˜ê¸°</button>
            <div class="status-msg" id="registerStatus"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
// Firebase ì„¤ì •
const firebaseConfig = {
    apiKey: "AIzaSyDhwvdHmU9tfwZVNHosFIeCVz-ejoWvQgU",
    authDomain: "stribe-management.firebaseapp.com",
    projectId: "stribe-management",
    storageBucket: "stribe-management.firebasestorage.app",
    messagingSenderId: "169343581314",
    appId: "1:169343581314:web:5abfafa5bd6c98bc81c89b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let players = [];
let currentPlayer = null;

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    loadPlayers();
    setupEventListeners();
    initDates();
});

function initDates() {
    const today = new Date();
    document.getElementById('workoutDatePicker').value = today.toISOString().split('T')[0];
    document.getElementById('conditionDate').textContent = 
        (today.getMonth()+1) + 'ì›” ' + today.getDate() + 'ì¼ ì»¨ë””ì…˜ ì²´í¬';
}

// ì„ ìˆ˜ ëª©ë¡ ë¡œë“œ
async function loadPlayers() {
    try {
        const snapshot = await db.collection('players').get();
        players = snapshot.docs.map(doc => ({
            id: doc.id,
            name: doc.data().name,
            birth: formatBirth(doc.data().birthdate),
            team: doc.data().team,
            pos: doc.data().position,
            sport: doc.data().sport
        }));
    } catch (error) {
        console.error('ì„ ìˆ˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

function formatBirth(birthdate) {
    if (!birthdate) return '';
    let s = String(birthdate).replace(/[\.\-\/]/g, '');
    if (s.length === 8) s = s.slice(2);
    if (s.length < 6) s = s.padStart(6, '0');
    return s;
}

function normalizeInput(birth) {
    let s = birth.replace(/[\.\-\/]/g, '');
    if (s.length === 8) return s.slice(2);
    if (s.length < 6) return s.padStart(6, '0');
    return s;
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
function setupEventListeners() {
    // ë¡œê·¸ì¸
    document.getElementById('loginBtn').onclick = handleLogin;
    document.getElementById('logoutBtn').onclick = () => showScreen('loginScreen');
    document.getElementById('refreshBtn').onclick = refreshData;

    // ë©”ë‰´
    document.getElementById('btnCondition').onclick = () => showScreen('conditionScreen');
    document.getElementById('btnWorkout').onclick = () => {
        showScreen('workoutScreen');
        loadWorkoutByDate(document.getElementById('workoutDatePicker').value);
    };
    document.getElementById('btnTest').onclick = () => alert('ì¤€ë¹„ì¤‘');

    // ë’¤ë¡œê°€ê¸°
    document.getElementById('conditionBack').onclick = () => showScreen('mainScreen');
    document.getElementById('workoutBack').onclick = () => showScreen('mainScreen');
    document.getElementById('registerBack').onclick = () => showScreen('loginScreen');

    // ë‚ ì§œ ë³€ê²½
    document.getElementById('workoutDatePicker').onchange = function() {
        loadWorkoutByDate(this.value);
    };

    // ìˆ«ì ì…ë ¥ ë²„íŠ¼
    setupNumberButtons('protein', 'proteinCount', 1, 0, 10);
    setupNumberButtons('water', 'waterIntake', 0.25, 0, 10);
    setupNumberButtons('time', 'trainingTime', 10, 0, 300);

    // RPE ìŠ¬ë¼ì´ë”
    document.getElementById('rpeSlider').oninput = updateRpe;

    // ì €ì¥
    document.getElementById('saveConditionBtn').onclick = saveCondition;
    document.getElementById('submitRegister').onclick = registerPlayer;

    // ëª¨ë‹¬
    document.getElementById('modalCancel').onclick = () => {
        document.getElementById('registerModal').classList.remove('active');
    };
    document.getElementById('modalConfirm').onclick = () => {
        document.getElementById('registerModal').classList.remove('active');
        document.getElementById('regName').value = document.getElementById('nameInput').value.trim();
        document.getElementById('regBirth').value = document.getElementById('birthInput').value.trim();
        showScreen('registerScreen');
    };
}

function setupNumberButtons(prefix, inputId, step, min, max) {
    const input = document.getElementById(inputId);
    document.getElementById(prefix + 'Minus').onclick = () => {
        input.value = Math.max(min, parseFloat(input.value) - step).toFixed(step < 1 ? 2 : 0);
    };
    document.getElementById(prefix + 'Plus').onclick = () => {
        input.value = Math.min(max, parseFloat(input.value) + step).toFixed(step < 1 ? 2 : 0);
    };
}

function updateRpe() {
    const val = document.getElementById('rpeSlider').value;
    const emojis = ['ğŸ˜´','ğŸ˜´','ğŸ™‚','ğŸ™‚','ğŸ˜','ğŸ˜','ğŸ˜¤','ğŸ˜¤','ğŸ¥µ','ğŸ¥µ'];
    const texts = ['ë§¤ìš° ì‰¬ì›€','ì‰¬ì›€','ì•½ê°„ ì‰¬ì›€','ë³´í†µ ì´í•˜','ë³´í†µ','ë³´í†µ ì´ìƒ','í˜ë“¦','ë§ì´ í˜ë“¦','ë§¤ìš° í˜ë“¦','ìµœëŒ€ ê°•ë„'];
    document.getElementById('rpeDisplay').textContent = emojis[val-1] + ' ìê°ë„: ' + val + '/10 - ' + texts[val-1];
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// ë¡œê·¸ì¸
function handleLogin() {
    const name = document.getElementById('nameInput').value.trim();
    const birth = normalizeInput(document.getElementById('birthInput').value.trim());
    const errorMsg = document.getElementById('errorMsg');
    
    const found = players.find(p => p.name === name && p.birth === birth);
    
    if (found) {
        currentPlayer = found;
        displayPlayerInfo(found);
        showScreen('mainScreen');
        loadTodayTasks();
        errorMsg.style.display = 'none';
    } else {
        document.getElementById('registerModal').classList.add('active');
    }
}

function displayPlayerInfo(player) {
    document.getElementById('pName').textContent = player.name;
    
    const year = parseInt(player.birth.substr(0,2));
    const fullYear = year > 50 ? 1900 + year : 2000 + year;
    const month = player.birth.substr(2,2);
    const day = player.birth.substr(4,2);
    
    const today = new Date();
    let age = today.getFullYear() - fullYear;
    if (today < new Date(today.getFullYear(), parseInt(month)-1, parseInt(day))) age--;
    
    document.getElementById('pInfo').textContent = fullYear + '-' + month + '-' + day + ' (ë§Œ ' + age + 'ì„¸)';
    document.getElementById('pDetail').textContent = player.team + ' | ' + player.pos + ' | ' + player.sport;
}

// ì˜¤ëŠ˜ ê³¼ì œ ë¡œë“œ
async function loadTodayTasks() {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    document.getElementById('mainTodayDate').textContent = (today.getMonth()+1) + 'ì›” ' + today.getDate() + 'ì¼';
    document.getElementById('mainTaskStatus').textContent = 'ë¡œë”©ì¤‘...';
    
    try {
        const snapshot = await db.collection('tasks')
            .where('player', '==', currentPlayer.name)
            .where('date', '==', todayStr)
            .limit(1)
            .get();
        
        if (!snapshot.empty) {
            const task = snapshot.docs[0].data();
            document.getElementById('mainWater').textContent = task.water ? task.water + 'L' : '-';
            document.getElementById('mainProtein').textContent = task.protein ? task.protein + 'íšŒ' : '-';
            document.getElementById('mainFood').textContent = task.food || '-';
            document.getElementById('mainRecovery').textContent = task.recovery || '-';
            document.getElementById('mainExercise').textContent = task.exercise || '-';
            
            if (task.videoLink) {
                document.getElementById('mainVideoLink').href = task.videoLink;
                document.getElementById('mainVideoLink').style.display = 'block';
            } else {
                document.getElementById('mainVideoLink').style.display = 'none';
            }
            document.getElementById('mainTaskStatus').textContent = 'âœ“ ì‹¤ì‹œê°„ ë°ì´í„°';
        } else {
            setDefaultTasks();
        }
    } catch (error) {
        console.error('ê³¼ì œ ë¡œë“œ ì‹¤íŒ¨:', error);
        setDefaultTasks();
    }
}

function setDefaultTasks() {
    document.getElementById('mainWater').textContent = '-';
    document.getElementById('mainProtein').textContent = '-';
    document.getElementById('mainFood').textContent = '-';
    document.getElementById('mainRecovery').textContent = '-';
    document.getElementById('mainExercise').textContent = '-';
    document.getElementById('mainVideoLink').style.display = 'none';
    document.getElementById('mainTaskStatus').textContent = 'ì˜¤ëŠ˜ ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤';
}

// í›ˆë ¨ ì¼ì§€ ë¡œë“œ
async function loadWorkoutByDate(dateStr) {
    const parts = dateStr.split('-');
    document.getElementById('workoutDate').textContent = parseInt(parts[1]) + 'ì›” ' + parseInt(parts[2]) + 'ì¼ í›ˆë ¨';
    
    const container = document.getElementById('workoutList');
    container.innerHTML = '<div class="section-card" style="text-align:center;color:#888;">ë¡œë”©ì¤‘...</div>';
    
    try {
        const snapshot = await db.collection('trainingLogs')
            .where('playerName', '==', currentPlayer.name)
            .where('playerBirth', '==', currentPlayer.birth)
            .get();
        
        const workouts = snapshot.docs
            .map(doc => doc.data())
            .filter(w => w.datetime && w.datetime.startsWith(dateStr));
        
        if (workouts.length > 0) {
            renderWorkouts(workouts);
        } else {
            container.innerHTML = '<div class="section-card no-workout"><div class="no-workout-icon">ğŸ“­</div><div class="no-workout-text">í•´ë‹¹ ë‚ ì§œì— ë“±ë¡ëœ í›ˆë ¨ì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
        }
    } catch (error) {
        console.error('í›ˆë ¨ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<div class="section-card no-workout"><div class="no-workout-icon">âš ï¸</div><div class="no-workout-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div></div>';
    }
}

function renderWorkouts(workouts) {
    const container = document.getElementById('workoutList');
    const icons = {
        'í•„ë“œí›ˆë ¨': 'âš½', 'ì§í›ˆë ¨': 'ğŸ‹ï¸', 'í•„ë“œ+ì§': 'ğŸ’ª',
        'ì „ìˆ í›ˆë ¨': 'ğŸ“‹', 'íšŒë³µí›ˆë ¨': 'ğŸ§˜', 'ê²½ê¸°': 'ğŸ†'
    };
    
    let html = '';
    workouts.forEach(w => {
        const time = w.datetime ? w.datetime.split('T')[1] || '' : '';
        const icon = icons[w.concept] || 'ğŸƒ';
        
        html += `<div class="workout-card">
            <div class="workout-header">
                <div class="workout-concept">${icon} ${w.concept || 'í›ˆë ¨'}</div>
                <div class="workout-time">ğŸ• ${time}</div>
            </div>
            <div class="workout-info">â±ï¸ ${w.duration || '-'}ë¶„</div>
            ${w.purpose ? `<div class="workout-purpose"><div class="workout-purpose-label">í›ˆë ¨ ëª©ì </div><div class="workout-purpose-text">${w.purpose}</div></div>` : ''}
            ${w.content ? `<div class="workout-content"><div class="workout-content-label">í›ˆë ¨ ë‚´ìš©</div><div class="workout-content-text">${w.content}</div></div>` : ''}
            ${w.imageUrl ? `<img class="workout-image" src="${w.imageUrl}">` : ''}
        </div>`;
    });
    
    container.innerHTML = html;
}

// ì»¨ë””ì…˜ ì €ì¥
async function saveCondition() {
    const btn = document.getElementById('saveConditionBtn');
    const status = document.getElementById('saveStatus');
    
    const recovery = [];
    if (document.getElementById('recFoamroller').checked) recovery.push('í¼ë¡¤ëŸ¬');
    if (document.getElementById('recStretching').checked) recovery.push('ìŠ¤íŠ¸ë ˆì¹­');
    if (document.getElementById('recMassage').checked) recovery.push('ë§ˆì‚¬ì§€');
    if (document.getElementById('recCold').checked) recovery.push('ëƒ‰ì°œì§ˆ');
    if (document.getElementById('recHot').checked) recovery.push('ì˜¨ì°œì§ˆ');
    if (document.getElementById('recCompression').checked) recovery.push('ì••ë°•ì˜ë¥˜');
    
    const today = new Date();
    const data = {
        date: today.toISOString().split('T')[0],
        player: currentPlayer.name,
        playerBirth: currentPlayer.birth,
        breakfast: document.getElementById('mealBreakfast').value,
        lunch: document.getElementById('mealLunch').value,
        dinner: document.getElementById('mealDinner').value,
        protein: document.getElementById('proteinCount').value,
        water: document.getElementById('waterIntake').value,
        injury: document.getElementById('injuryArea').value || 'ì—†ìŒ',
        recovery: recovery.join(', ') || 'ì—†ìŒ',
        rpe: document.getElementById('rpeSlider').value,
        trainingTime: document.getElementById('trainingTime').value,
        trainingConcept: document.getElementById('trainingConcept').value,
        painNote: document.getElementById('painNote').value || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    btn.disabled = true;
    btn.textContent = 'ì €ì¥ ì¤‘...';
    
    try {
        await db.collection('conditions').add(data);
        btn.disabled = false;
        btn.textContent = 'ì €ì¥í•˜ê¸°';
        status.textContent = 'âœ“ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
        setTimeout(() => showScreen('mainScreen'), 1500);
    } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        btn.disabled = false;
        btn.textContent = 'ì €ì¥í•˜ê¸°';
        status.textContent = 'ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
}

// ì„ ìˆ˜ ë“±ë¡
async function registerPlayer() {
    const name = document.getElementById('regName').value.trim();
    const birth = normalizeInput(document.getElementById('regBirth').value.trim());
    const sport = document.getElementById('regSport').value;
    const team = document.getElementById('regTeam').value.trim();
    const position = document.getElementById('regPosition').value.trim();
    const status = document.getElementById('registerStatus');
    
    if (!name || !birth || !sport || !team || !position) {
        status.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        status.style.color = '#ff6b6b';
        return;
    }
    
    const btn = document.getElementById('submitRegister');
    btn.disabled = true;
    btn.textContent = 'ë“±ë¡ì¤‘...';
    
    try {
        await db.collection('players').add({
            name: name,
            birthdate: birth,
            team: team,
            position: position,
            sport: sport,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        btn.disabled = false;
        btn.textContent = 'ë“±ë¡í•˜ê¸°';
        status.style.color = 'rgba(255,255,255,0.9)';
        status.textContent = 'âœ“ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
        
        await loadPlayers();
        setTimeout(() => showScreen('loginScreen'), 1500);
    } catch (error) {
        console.error('ë“±ë¡ ì‹¤íŒ¨:', error);
        btn.disabled = false;
        btn.textContent = 'ë“±ë¡í•˜ê¸°';
        status.style.color = '#ff6b6b';
        status.textContent = 'ë“±ë¡ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
}

// ìƒˆë¡œê³ ì¹¨
async function refreshData() {
    const btn = document.getElementById('refreshBtn');
    btn.textContent = 'ë¡œë”©...';
    
    await loadPlayers();
    if (currentPlayer) {
        await loadTodayTasks();
    }
    
    btn.textContent = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
}
</script></body></html>
